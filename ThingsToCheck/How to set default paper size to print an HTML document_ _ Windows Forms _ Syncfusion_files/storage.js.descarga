function lsTest(){var test="test";try{return localStorage.setItem(test,test),localStorage.removeItem(test),!0}catch(e){return!1}}function isObject(o){return o&&"object"==typeof o}function extendObject(curr,o){for(var k in o)o.hasOwnProperty(k)&&(curr[k]=o[k]);return curr}function post(m,a){var d={storage:m};a&&(d.data=a),d.swaychat_storage=!0,parent.postMessage(JSON.stringify(d),"*")}function cleanUp(){for(var x=0;x<i.value.length-max;x++){var ts=new Storage(i.value[x]),nv=ts.get();if(nv){for(var ni in nv)-1==retain.indexOf(ni)&&delete nv[ni];ts.set(nv)}}}var storage=lsTest();window.isLocalStorageSupported=window.isLocalStorageSupported||lsTest;var Storage=function(key){this.expire=12096e5,"string"==typeof key&&(this.name=key),this.get()};Storage.prototype={set:function(value){this.value=value;var v=JSON.stringify(value);if(storage)return localStorage.setItem(this.name,v),void 0;if(this.expire){var date=new Date;date.setTime(date.getTime()+this.expire);var expires="; expires="+date.toGMTString()}else var expires="";document.cookie=this.name+"="+v+expires+"; path=/"},get:function(){var v;if(storage)v=localStorage.getItem(this.name);else{var match=new RegExp("("+this.name+")=([^;]*)").exec(document.cookie);match&&(v=match[2])}return this.is_json_str(v)&&(this.value="string"==typeof v?JSON.parse(v):null),this.value},is_json_str:function(str){try{JSON.parse(str)}catch(e){return!1}return!0},del:function(){storage&&localStorage.removeItem(this.name),this.expire=-1,this.set()},extend:function(o){var currentValue=this.get();if(!isObject(currentValue))throw new Error("The storage value must be initialized as an object first before it can be extended!");if(!isObject(o))throw new Error("o must be an object!");var newValue=extendObject(currentValue,o);this.set(newValue)},setProperty:function(k,v){var o={};o[k]=v,this.extend(o)},removeProperty:function(k){var o=this.get();k in o&&(delete o[k],this.set(o))},getProperty:function(k){return(this.get()||{})[k]},ensureIsObject:function(){var currentValue=this.get();isObject(currentValue)||this.set({})}},post("ready");var s,i=new Storage("swaychat_index");i.value||i.set([]);var max=5,retain=["state","uid","token"];window.onmessage=function(e){if(e.data&&"string"==typeof e.data&&0!=/swaychat_storage/.test(e.data)){var p={};if(p=JSON.parse(e.data),p.storage)switch(p.storage){case"sync":s=new Storage(p.data.key),s.get()||s.set({}),-1==i.value.indexOf(p.data.key)&&(i.value.push(p.data.key),i.set(i.value)),i.value.length>max&&cleanUp(),post("sync",s.value);break;case"save":s.value[p.data.key]=p.data.value,s.set(s.value),post("updated");break;case"del":delete s.value[p.data.key],s.set(s.value)}}};
//# sourceMappingURL=maps/storage.js.map
